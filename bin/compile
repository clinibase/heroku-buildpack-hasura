#!/usr/bin/env bash
set -eo pipefail

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-/tmp/cache}
ENV_DIR=${3:-}

HEROKU_DIR="$BUILD_DIR/.heroku"
BIN_DIR="$HEROKU_DIR/bin"

mkdir -p "$CACHE_DIR" "$BIN_DIR"

# Export ENV_DIR vars
if [ -d "$ENV_DIR" ]; then
  for e in $(ls "$ENV_DIR"); do
    export "$e=$(cat "$ENV_DIR/$e")"
  done
fi

# Versions
HASURA_IMAGE="${HASURA_IMAGE:-hasura/graphql-engine}"
HASURA_VERSION="${HASURA_VERSION:-v2.48.6}"

if [[ $HASURA_VERSION =~ ^[0-9] ]]; then
  HASURA_VERSION="v${HASURA_VERSION}"
fi

IMAGE_TAG="${HASURA_IMAGE}:${HASURA_VERSION}.cli-migrations-v3"

ENGINE_BIN="$CACHE_DIR/graphql-engine"
CLI_BIN="$CACHE_DIR/hasura-cli"
ORAS_BIN="$CACHE_DIR/oras"

OS="linux"
ARCH="amd64"

# --------------------------------------------------------------------
# Fetch binaries from OCI image
# --------------------------------------------------------------------
if [ -f "$ENGINE_BIN" ] && [ -f "$CLI_BIN" ]; then
  echo "-----> Using Hasura binaries from cache"
else
  # --------------------------------------------------------------------
  # Install oras (static binary)
  # --------------------------------------------------------------------
  if [ ! -f "$ORAS_BIN" ]; then
    echo "-----> Installing oras"
    curl -fsSL \
      https://github.com/oras-project/oras/releases/download/v1.2.0/oras_1.2.0_${OS}_${ARCH}.tar.gz \
      | tar -xz -C "$CACHE_DIR" oras
  fi
  chmod +x "$ORAS_BIN"

  echo "-----> Pulling ${IMAGE_TAG} (no Docker)"

  TMP_DIR="$(mktemp -d)"

  "$ORAS_BIN" pull \
    "$IMAGE_TAG" \
    --output "$TMP_DIR" \
    --artifact-type application/vnd.oci.image.layer.v1.tar

  # Find and extract layer containing /bin
  for layer in "$TMP_DIR"/*.tar; do
    if tar -tf "$layer" | grep -q "^bin/graphql-engine$"; then
      tar -xf "$layer" -C "$TMP_DIR" bin/graphql-engine bin/hasura-cli
      break
    fi
  done

  mv "$TMP_DIR/bin/graphql-engine" "$ENGINE_BIN"
  mv "$TMP_DIR/bin/hasura-cli" "$CLI_BIN"
fi

# --------------------------------------------------------------------
# Install
# --------------------------------------------------------------------
chmod +x "$ENGINE_BIN" "$CLI_BIN"

cp "$ENGINE_BIN" "$BIN_DIR/graphql-engine"
cp "$CLI_BIN" "$BIN_DIR/hasura-cli"

export PATH="$BIN_DIR:$PATH"

echo "-----> Installed Hasura:"
graphql-engine version
hasura-cli version