#!/usr/bin/env bash
set -eo pipefail

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-/tmp/cache}
ENV_DIR=${3:-}

HEROKU_DIR="$BUILD_DIR/.heroku"
BIN_DIR="$HEROKU_DIR/bin"

mkdir -p "$CACHE_DIR" "$BIN_DIR"

# Export ENV_DIR vars
if [ -d "$ENV_DIR" ]; then
  for e in $(ls "$ENV_DIR"); do
    export "$e=$(cat "$ENV_DIR/$e")"
  done
fi

# Versions
HASURA_IMAGE="${HASURA_IMAGE:-hasura/graphql-engine}"
HASURA_VERSION="${HASURA_VERSION:-v2.48.6}"
HASURA_CACHE_ENABLED="${HASURA_CACHE_ENABLED:-true}"

if [[ $HASURA_VERSION =~ ^[0-9] ]]; then
  HASURA_VERSION="v${HASURA_VERSION}"
fi

IMAGE_TAG="${HASURA_IMAGE}:${HASURA_VERSION}.cli-migrations-v3"

ENGINE_BIN="$CACHE_DIR/graphql-engine"
CLI_BIN="$CACHE_DIR/hasura-cli"
CRANE_BIN="$CACHE_DIR/crane"

OS="linux"
ARCH="amd64"

# --------------------------------------------------------------------
# Fetch binaries from OCI image
# --------------------------------------------------------------------
if [ -f "$ENGINE_BIN" ] && [ -f "$CLI_BIN" ]; then
  echo "-----> Using Hasura binaries from cache"
else
  echo "-----> Installing crane (for daemonless image export)"
  # The go-containerregistry release tarball contains crane (and others).  [oai_citation:2‡Google Cloud Documentation](https://docs.cloud.google.com/artifact-registry/docs/docker/copy-images?utm_source=chatgpt.com)
  curl -fsSL \
    https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz \
    | tar -xz -C "$CACHE_DIR" crane
  chmod +x "$CRANE_BIN"

  echo "-----> Pulling ${IMAGE_TAG} (no Docker) and extracting /bin/graphql-engine and /bin/hasura-cli"
  TMP_DIR="$(mktemp -d)"
  trap 'rm -rf "$TMP_DIR"' EXIT

  # crane export emits a tar of the image filesystem.  [oai_citation:3‡GitHub](https://github.com/google/go-containerregistry/blob/main/cmd/crane/recipes.md?utm_source=chatgpt.com)
  # IMPORTANT: tar paths must NOT start with '/'.  [oai_citation:4‡GitHub](https://github.com/google/go-containerregistry/blob/main/cmd/crane/recipes.md?utm_source=chatgpt.com)
  "$CRANE_BIN" export "$IMAGE_TAG" - \
    | tar -C "$TMP_DIR" -xf - usr/bin/graphql-engine usr/bin/hasura-cli

  rm -f "$CRANE_BIN"
  mv "$TMP_DIR/usr/bin/graphql-engine" "$ENGINE_BIN"
  mv "$TMP_DIR/usr/bin/hasura-cli" "$CLI_BIN"
fi

# --------------------------------------------------------------------
# Install
# --------------------------------------------------------------------
chmod +x "$ENGINE_BIN" "$CLI_BIN"

cp_or_mv_cmd="mv"
if [ "$HASURA_CACHE_ENABLED" = "true" ]; then
  cp_or_mv_cmd="cp"
fi

$cp_or_mv_cmd "$ENGINE_BIN" "$BIN_DIR/graphql-engine"
$cp_or_mv_cmd "$CLI_BIN" "$BIN_DIR/hasura-cli"

export PATH="$BIN_DIR:$PATH"

echo "-----> Installed Hasura:"
graphql-engine version
hasura-cli version